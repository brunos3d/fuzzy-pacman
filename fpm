#!/usr/bin/env bash
# fpm - fuzzy pacman wrapper using skim (sk)
set -euo pipefail

cache_dir="/var/cache/pacman/pkg"

_sk() {
  local header="$1"; shift
  sk \
    --ansi \
    --height 40% \
    --reverse \
    --prompt "fpm> " \
    --bind "tab:toggle+down,ctrl-u:half-page-up,ctrl-d:half-page-down" \
    --header "$header" \
    "$@"
}

_require_sk() { command -v sk >/dev/null || { echo "skim (sk) missing"; exit 1; }; }
_require_pacman() { command -v pacman >/dev/null || { echo "pacman missing"; exit 1; }; }

# new sync command
fpm_sync() {
  _require_pacman
  sudo -v || exit 1
  echo "ðŸ”„ Syncing pacman databases..."
  sudo pacman -Sy
}

_auto_sync() {
  fpm_sync
}

fpm_add() {
  _auto_sync
  _require_sk; _require_pacman
  sudo -v || exit 1
  pacman -Sl | \
    _sk "TAB=select â€¢ ENTER=install" --multi --preview "pacman -Si {2}" | \
    awk '{print $2}' | \
    xargs -r sudo pacman -S --
}

fpm_rm() {
  _require_sk
  sudo -v || exit 1
  pacman -Q | \
    _sk "TAB=select â€¢ ENTER=remove" --multi --preview "pacman -Qi {1}" | \
    awk '{print $1}' | \
    xargs -r sudo pacman -Rns --
}

fpm_search() {
  _auto_sync
  _require_sk
  pacman -Sl | _sk "Search repo packages" --preview "pacman -Si {2}"
}

fpm_info() {
  _auto_sync
  _require_sk
  pacman -Q | _sk "Inspect package" --preview "pacman -Qi {1}"
}

fpm_update() {
  _auto_sync
  _require_sk
  pacman -Qu | _sk "Updates available" --preview "pacman -Si {1}"
}

fpm_files() {
  _require_sk
  pacman -Q | _sk "List package files" --preview "pacman -Ql {1}"
}

fpm_orphans() {
  _require_sk
  sudo -v || exit 1
  pacman -Qdt | \
    _sk "TAB=select â€¢ ENTER=remove orphans" --multi --preview "pacman -Qi {1}" | \
    awk '{print $1}' | \
    xargs -r sudo pacman -Rns --
}

fpm_file() {
  _require_sk
  pacman -Fl | _sk "File provider" --preview "pacman -Fl {1}"
}

fpm_own() {
  _require_sk
  find /usr -type f 2>/dev/null | \
    _sk "File owner" --preview "pacman -Qo {}"
}

fpm_repo() {
  _require_sk
  REPO=$(printf "core\nextra\ncommunity\nmultilib" | _sk "Select repo")
  [ -z "${REPO:-}" ] && return
  pacman -Sl "$REPO" | _sk "Browsing $REPO" --preview "pacman -Si {2}"
}

fpm_svc() {
  _require_sk
  systemctl list-units --type=service --all --no-pager | \
    awk '{print $1}' | \
    _sk "systemd services" --preview "systemctl status {1} --no-pager"
}


fpm_cache() {
  _require_sk
  sudo -v || exit 1
  while true; do
    sel=$(ls -1 "$cache_dir" | _sk "TAB=select â€¢ ENTER=delete â€¢ ESC=quit" --multi --preview "ls -lh $cache_dir/{1}")
    [ -z "${sel:-}" ] && break
    printf '%s\n' "$sel" | while read -r f; do sudo rm -v "$cache_dir/$f"; done
  done
}

fpm_bulk() {
  _require_sk
  ACTION=$(printf "%s\n" \
    "Sync pacman databases" \
    "Install packages" \
    "Remove packages" \
    "Search repository packages" \
    "Inspect installed packages" \
    "List files of installed packages" \
    "Remove orphan dependencies" \
    "Show available updates" \
    "Package providing a file (repo)" \
    "Package owning a file (system)" \
    "Browse repository" \
    "Systemd services browser" \
    "Clean cache (simple)" \
    "Clean cache (interactive)" \
    | _sk "Select action")
  case "$ACTION" in
    "Sync pacman databases") fpm_sync ;;
    "Install packages") fpm_add ;;
    "Remove packages") fpm_rm ;;
    "Search repository packages") fpm_search ;;
    "Inspect installed packages") fpm_info ;;
    "List files of installed packages") fpm_files ;;
    "Remove orphan dependencies") fpm_orphans ;;
    "Show available updates") fpm_update ;;
    "Package providing a file (repo)") fpm_file ;;
    "Package owning a file (system)") fpm_own ;;
    "Browse repository") fpm_repo ;;
    "Systemd services browser") fpm_svc ;;
    "Clean cache (interactive)") fpm_cache ;;
  esac
}

fpm_help() {
cat <<EOF
fpm - fuzzy pacman wrapper

Commands:
  sync      Sync pacman databases (pacman -Sy)
  add       Install packages
  rm        Remove packages
  search    Search repository
  info      Inspect installed packages
  update    Show updates
  files     List package files
  orphans   Remove orphan dependencies
  file      Repo file provider lookup
  own       Installed file owner lookup
  repo      Browse repositories
  svc       Browse systemd services
  cache     Clean pacman cache
  bulk      Bulk menu
  help      Show help
EOF
}

_main() {
  if [ $# -eq 0 ]; then fpm_help; return; fi
  cmd="$1"; shift
  case "$cmd" in
    sync) fpm_sync ;;
    add) fpm_add ;;
    rm) fpm_rm ;;
    search) fpm_search ;;
    info) fpm_info ;;
    update) fpm_update ;;
    files) fpm_files ;;
    orphans) fpm_orphans ;;
    file) fpm_file ;;
    own) fpm_own ;;
    repo) fpm_repo ;;
    svc) fpm_svc ;;
    cache) fpm_cache ;;
    bulk) fpm_bulk ;;
    help|-h|--help) fpm_help ;;
    *) echo "Unknown command: $cmd"; fpm_help; exit 1 ;;
  esac
}

_main "$@"
